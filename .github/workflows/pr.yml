name: PR Automation

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  pr:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' }}
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_REPO: ${{ github.repository }}
    steps:
      - name: Checkout CI commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Create PR and Auto-merge
        run: |
          # 1. 変数のセットアップ
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          echo "Target Branch: $BRANCH"

          if [ -z "$BRANCH" ]; then
            echo "Error: No branch name found."
            exit 1
          fi

          # 2. 対象ブランチのフィルタリング
          case "$BRANCH" in
            feature/*|fix/*) ;;
            *) echo "Branch $BRANCH is not eligible. Skipping."; exit 0 ;;
          esac

          # 3. Git環境の整備 (ここが重要: 比較元をfetchし、ローカルブランチを作成)
          git fetch origin main
          git checkout -b "$BRANCH"

          # 4. 既存PRの確認
          PR_NUMBER=$(gh pr list --head "$BRANCH" --base main --json number -q '.[0].number')

          if [ -n "$PR_NUMBER" ]; then
            echo "PR already exists: #$PR_NUMBER"
          else
            echo "Creating new PR..."
            
            # コミットメッセージからタイトルと本文を取得 (gh --fill の代わり)
            # -s: 件名(Subject), -b: 本文(Body)
            PR_TITLE=$(git log -1 --pretty=%s)
            PR_BODY=$(git log -1 --pretty=%b)

            # 空の場合のデフォルト値
            if [ -z "$PR_TITLE" ]; then PR_TITLE="Auto-created PR for $BRANCH"; fi
            if [ -z "$PR_BODY" ]; then PR_BODY="Automated PR creation."; fi

            # PR作成 (明示的にタイトルと本文を渡すことでgitエラーを回避)
            gh pr create \
              --head "$BRANCH" \
              --base main \
              --title "$PR_TITLE" \
              --body "$PR_BODY"
            
            # 番号を再取得
            PR_NUMBER=$(gh pr list --head "$BRANCH" --base main --json number -q '.[0].number')
          fi

          # 5. オートマージの設定
          if [ -n "$PR_NUMBER" ]; then
            echo "Enabling auto-merge for PR #$PR_NUMBER"
            gh pr merge "$PR_NUMBER" --auto --squash --delete-branch
          else
            echo "Error: Failed to retrieve PR number."
            exit 1
          fi
